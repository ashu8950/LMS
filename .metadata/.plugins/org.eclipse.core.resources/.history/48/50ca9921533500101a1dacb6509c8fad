package com.auth_service.service;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;

@Service
public class EmailService {

    @Autowired
    private JavaMailSender mailSender;

    
    public void sendOtpEmail(String toEmail, String otp) {
        String subject = "LMS Verification Code - Complete Your Registration";
        String body = """
            <div style='font-family: Arial, sans-serif; padding: 10px;'>
                <h2 style='color: #2e6da4;'>Welcome to LMS</h2>
                <p>To continue with your registration, please use the following OTP:</p>
                <h1 style='color: #d9534f;'>%s</h1>
                <p>This OTP is valid for a limited time. Do not share it with anyone.</p>
                <hr>
                <small>If you didnâ€™t request this, please ignore this message.</small>
            </div>
            """.formatted(otp);

        sendHtmlEmail(toEmail, subject, body);
    }

    
    public void sendWelcomeEmail(String toEmail, String name) {
        String subject = "ðŸŽ‰ Welcome to LMS â€“ Letâ€™s Get Started!";
        String body = """
            <div style='font-family: Arial, sans-serif; padding: 10px;'>
                <h2 style='color: #5cb85c;'>Hi %s,</h2>
                <p>Thank you for joining <strong>LMS (Learning Management System)</strong>.</p>
                <p>You can now log in, explore courses, and begin your learning journey.</p>
                <p>Weâ€™re excited to have you with us!</p>
                <br>
                <p>â€” The LMS Team</p>
            </div>
            """.formatted(name);

        sendHtmlEmail(toEmail, subject, body);
    }

    
    private void sendHtmlEmail(String to, String subject, String htmlBody) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(
                message,
                MimeMessageHelper.MULTIPART_MODE_MIXED_RELATED,
                "UTF-8"
            );

            helper.setTo(to);
            helper.setSubject(subject);
            helper.setText(htmlBody, true);  // true = HTML

            mailSender.send(message);
        } catch (MessagingException e) {
            throw new RuntimeException("Failed to send email to " + to, e);
        }
    }
}
