package com.auth_service.service;

import com.auth_service.entity.Token;
import com.auth_service.entity.User;
import com.auth_service.repository.TokenRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class TokenService {

    private final TokenRepository tokenRepository;

    /**
     * Save a new token for a user.
     */
    public void saveUserToken(User user, String jwtToken, String tokenType, LocalDateTime expiresAt) {
        Token token = new Token();
        token.setToken(jwtToken);
        token.setUser(user);
        token.setExpired(false);
        token.setRevoked(false);
        token.setTokenType(tokenType);
        token.setCreatedAt(LocalDateTime.now());
        token.setExpiresAt(expiresAt);
        tokenRepository.save(token);
        log.debug("Saved {} token for user {}", tokenType, user.getEmail());
    }

    /**
     * Revoke all currently valid tokens for the given user.
     */
    public void revokeAllUserTokens(User user) {
        List<Token> validTokens = tokenRepository
            .findAllByUserAndExpiredIsFalseAndRevokedIsFalse(user);
        validTokens.forEach(token -> {
            token.setExpired(true);
            token.setRevoked(true);
        });
        tokenRepository.saveAll(validTokens);
        log.debug("Revoked {} tokens for user {}", validTokens.size(), user.getEmail());
    }

    /**
     * Check if a given token string is valid (exists, not expired, not revoked).
     */
    public boolean isTokenValid(String jwtToken) {
        return tokenRepository.findByToken(jwtToken)
                .map(t -> !t.isExpired() && !t.isRevoked())
                .orElse(false);
    }

    /**
     * Revoke a single token by its string value.
     */
    public void revokeToken(String jwtToken) {
        Token token = tokenRepository.findByToken(jwtToken)
                .orElseThrow(() -> new IllegalArgumentException("Token not found: " + jwtToken));
        token.setExpired(true);
        token.setRevoked(true);
        tokenRepository.save(token);
        log.debug("Revoked token for user {}", token.getUser().getEmail());
    }
}
