package com.auth_service.service;

import java.time.Duration;

import com.auth_service.dto.RegisterRequest;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
@Slf4j
public class OtpService {

    private final RedisTemplate<String, Object> redisTemplate;

    private static final String OTP_PREFIX = "otp:";
    private static final String REG_PREFIX = "reg:";

    // Save OTP with 5-minute expiration
    public void saveOtp(String email, String otp) {
        if (email != null && otp != null) {
            redisTemplate.opsForValue().set(generateOtpKey(email), otp, Duration.ofMinutes(5));
        }
    }

    public String getOtp(String email) {
        if (email == null) return null;
        Object otp = redisTemplate.opsForValue().get(generateOtpKey(email));
        log.info("Fetched OTP for {}: {}", email, otp);
        return otp != null ? otp.toString() : null;
    }

    public void deleteOtp(String email) {
        if (email != null) {
            redisTemplate.delete(generateOtpKey(email));
        }
    }

    // Save RegisterRequest object with 5-minute expiration
    public void saveRegistrationData(String email, RegisterRequest req) {
        if (email != null && req != null) {
            redisTemplate.opsForValue().set(generateRegKey(email), req, Duration.ofMinutes(5));
        }
    }

    public RegisterRequest getRegistrationData(String email) {
        if (email == null) return null;
        Object data = redisTemplate.opsForValue().get(generateRegKey(email));
        if (data instanceof RegisterRequest) {
            return (RegisterRequest) data;
        }
        return null;
    }

    public void deleteRegistrationData(String email) {
        if (email != null) {
            redisTemplate.delete(generateRegKey(email));
        }
    }

    private String generateOtpKey(String email) {
        return OTP_PREFIX + email.toLowerCase().trim();
    }

    private String generateRegKey(String email) {
        return REG_PREFIX + email.toLowerCase().trim();
    }
}
