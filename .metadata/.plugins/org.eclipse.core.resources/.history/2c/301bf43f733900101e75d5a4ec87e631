package com.student_service.service.impl;

import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.student_service.dto.CourseDTO;
import com.student_service.dto.EnrollmentRequest;
import com.student_service.dto.FeedbackDto;
import com.student_service.dto.NotificationRequest;
import com.student_service.dto.StudentDTO;
import com.student_service.dto.UserDTO;
import com.student_service.entity.Enrollment;
import com.student_service.entity.Student;
import com.student_service.exception.StudentNotFoundException;
import com.student_service.exception.UserRoleInvalidException;
import com.student_service.feign_client.CourseClient;
import com.student_service.feign_client.NotificationClient;
import com.student_service.feign_client.UserClient;
import com.student_service.messaging.FeedbackPublisher;
import com.student_service.repository.EnrollmentRepository;
import com.student_service.repository.StudentRepository;
import com.student_service.service.StudentService;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class StudentServiceImpl implements StudentService {

    private final StudentRepository studentRepository;
    private final EnrollmentRepository enrollmentRepository;
    private final CourseClient courseClient;
    private final FeedbackPublisher feedbackPublisher;
    private final NotificationClient notificationClient;
    private final UserClient userClient;          // â† new

    @Override
    public Student registerStudent(StudentDTO dto) {
        // 1. Fetch the user from the User service
        UserDTO user = userClient.getUserById(dto.getUserId());
        if (user == null) {
            throw new StudentNotFoundException("No user found with ID: " + dto.getUserId());
        }
        // 2. Ensure they have the STUDENT role
        if (!"STUDENT".equalsIgnoreCase(user.getRole())) {
            throw new UserRoleInvalidException(
                "User with ID " + dto.getUserId() + " does not have the STUDENT role."
            );
        }

        // 3. Map and save
        Student student = new Student();
        student.setUserId(user.getId());
        student.setFirstName(dto.getFirstName());
        student.setLastName(dto.getLastName());
        student.setEmail(user.getEmail());           // prefer canonical email
        student.setPhone(dto.getPhone());
        student.setJoinedDate(dto.getJoinedDate());
        student.setStatus(dto.getStatus());

        return studentRepository.save(student);
    }

    @Override
    @Transactional
    public void enrollStudent(Long studentId, EnrollmentRequest req) {
        Student student = studentRepository.findById(studentId)
            .orElseThrow(() -> new StudentNotFoundException("Student not found with ID: " + studentId));

        Enrollment enrollment = new Enrollment();
        enrollment.setStudent(student);
        enrollment.setCourseId(req.getCourseId());
        enrollment.setBatchId(req.getBatchId());
        enrollment.setEnrollmentDate(LocalDate.now());
        enrollment.setStatus("ACTIVE");

        enrollmentRepository.save(enrollment);
    }

    @Override
    public List<CourseDTO> getEnrolledCourses(Long studentId) {
        if (!studentRepository.existsById(studentId)) {
            throw new StudentNotFoundException("Student not found with ID: " + studentId);
        }

        return enrollmentRepository.findByStudentId(studentId)
            .stream()
            .map(e -> courseClient.getCourseById(e.getCourseId()))
            .collect(Collectors.toList());
    }

    @Override
    public void sendFeedback(Long studentId, FeedbackDto feedback) {
        Student student = studentRepository.findById(studentId)
            .orElseThrow(() -> new StudentNotFoundException("Student not found with ID: " + studentId));

        feedback.setStudentId(studentId);
        feedback.setSubmittedDate(LocalDate.now());

        feedbackPublisher.publishFeedbackEvent(feedback);

        NotificationRequest notification = new NotificationRequest(
            student.getEmail(),
            "Thanks for your feedback",
            "Hi " + student.getFirstName() + ",\n\n" +
            "Thank you for submitting your feedback on " + feedback.getSubmittedDate() + 
            ". We appreciate your input!\n\n" +
            "Best,\nLMS Team"
        );

        try {
            notificationClient.sendEmail(notification);
        } catch (Exception ex) {
            // log and continue
            System.err.println("Failed to send feedback email: " + ex.getMessage());
        }
    }
}
