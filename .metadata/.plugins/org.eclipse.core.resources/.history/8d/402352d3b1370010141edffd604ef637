package com.user_service.service.impl;

import com.user_service.dto.UserProfileDTO;
import com.user_service.entity.UserProfile;
import com.user_service.repository.UserProfileRepository;
import com.user_service.service.UserProfileService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import jakarta.transaction.Transactional;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional
public class UserProfileServiceImpl implements UserProfileService {

    private final UserProfileRepository userProfileRepository;

    // Directory to save uploaded photos
    private final Path rootLocation = Paths.get("uploads/profile-photos");

    @Override
    public UserProfileDTO createUserProfile(UserProfileDTO dto) {
        UserProfile userProfile = toEntity(dto);
        userProfile = userProfileRepository.save(userProfile);
        return toDTO(userProfile);
    }

    @Override
    public UserProfileDTO updateUserProfile(UserProfileDTO dto) {
        Optional<UserProfile> existingOpt = userProfileRepository.findById(dto.getUserId());
        if (existingOpt.isEmpty()) {
            throw new RuntimeException("User profile not found with id " + dto.getUserId());
        }
        UserProfile existing = existingOpt.get();
        // Update fields
        existing.setFirstName(dto.getFirstName());
        existing.setLastName(dto.getLastName());
        existing.setPhoneNumber(dto.getPhoneNumber());
        existing.setBio(dto.getBio());
        existing.setProfileImageUrl(dto.getProfileImageUrl());
        existing.setRole(dto.getRole());
        existing.setEnabled(dto.getEnabled());
        // Add more updates as needed

        userProfileRepository.save(existing);
        return toDTO(existing);
    }

    @Override
    public Optional<UserProfileDTO> getUserProfile(Long userId) {
        return userProfileRepository.findById(userId).map(this::toDTO);
    }

    @Override
    public void deleteUserProfile(Long userId) {
        userProfileRepository.deleteById(userId);
    }

    @Override
    public List<UserProfileDTO> getAllUserProfiles() {
        return userProfileRepository.findAll().stream()
                .map(this::toDTO)
                .collect(Collectors.toList());
    }

    @Override
    public List<UserProfileDTO> getProfilesByRole(String role) {
        return userProfileRepository.findByRole(role).stream()
                .map(this::toDTO)
                .collect(Collectors.toList());
    }

    @Override
    public String storePhoto(Long userId, MultipartFile file) throws IOException {
        if (file.isEmpty()) {
            throw new RuntimeException("Failed to store empty file.");
        }

        // Make sure directory exists
        Files.createDirectories(rootLocation);

        String filename = userId + "_" + file.getOriginalFilename();
        Path destinationFile = rootLocation.resolve(Paths.get(filename))
                .normalize().toAbsolutePath();

        // Save file to disk
        try (var inputStream = file.getInputStream()) {
            Files.copy(inputStream, destinationFile);
        }

        // Update user's profileImageUrl field in DB
        Optional<UserProfile> profileOpt = userProfileRepository.findById(userId);
        if (profileOpt.isEmpty()) {
            throw new RuntimeException("User profile not found");
        }
        UserProfile profile = profileOpt.get();
        profile.setProfileImageUrl("/uploads/profile-photos/" + filename);
        userProfileRepository.save(profile);

        return filename;
    }

    // Helper method to convert entity to DTO
    private UserProfileDTO toDTO(UserProfile entity) {
        return UserProfileDTO.builder()
                .userId(entity.getAuthUserId())
                .email(entity.getEmail())
                .username(entity.getUsername())
                .role(entity.getRole())
                .enabled(entity.getEnabled())
                .firstName(entity.getFirstName())
                .lastName(entity.getLastName())
                .phoneNumber(entity.getPhoneNumber())
                .bio(entity.getBio())
                .profileImageUrl(entity.getProfileImageUrl())
                .build();
    }

    // Helper method to convert DTO to entity
    private UserProfile toEntity(UserProfileDTO dto) {
        return UserProfile.builder()
                .authUserId(dto.getUserId())
                .email(dto.getEmail())
                .username(dto.getUsername())
                .role(dto.getRole())
                .enabled(dto.getEnabled())
                .firstName(dto.getFirstName())
                .lastName(dto.getLastName())
                .phoneNumber(dto.getPhoneNumber())
                .bio(dto.getBio())
                .profileImageUrl(dto.getProfileImageUrl())
                .build();
    }
}
