package com.user_service.controllers;

import com.user_service.client.AuthServiceClient;
import com.user_service.dto.AuthUserDTO;
import com.user_service.dto.UserProfileDTO;
import com.user_service.service.UserProfileService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping("/api/profiles")
@RequiredArgsConstructor
public class UserProfileController {

    private final UserProfileService userProfileService;

    // Create a new user profile (user can create only their own)
    @PostMapping
    @PreAuthorize("#dto.email == authentication.principal.email or hasAuthority('ADMIN')")
    public ResponseEntity<UserProfileDTO> createProfile(@Valid @RequestBody UserProfileDTO dto) {
        UserProfileDTO createdProfile = userProfileService.createUserProfile(dto);
        return ResponseEntity.status(201).body(createdProfile);
    }

    // Update existing profile (user can update only their own)
    @PutMapping("/{userId}")
    @PreAuthorize("#userId == authentication.principal.userId or hasAuthority('ADMIN')")
    public ResponseEntity<UserProfileDTO> updateProfile(@PathVariable Long userId,
                                                        @Valid @RequestBody UserProfileDTO dto) {
        dto.setUserId(userId); // ensure consistency between path and body
        UserProfileDTO updatedProfile = userProfileService.updateUserProfile(dto);
        return ResponseEntity.ok(updatedProfile);
    }

    // Get profile by user ID (user can fetch only their own or authorized roles)
    @GetMapping("/{userId}")
    @PreAuthorize("hasAuthority('ADMIN') or hasAuthority('INSTRUCTOR') or #userId == authentication.principal.userId")
    public ResponseEntity<UserProfileDTO> getProfile(@PathVariable Long userId) {
        Optional<UserProfileDTO> profile = userProfileService.getUserProfile(userId);
        return profile.map(ResponseEntity::ok)
                      .orElseGet(() -> ResponseEntity.notFound().build());
    }

    //Delete profile by user ID (user can delete only their own)
    @DeleteMapping("/{userId}")
    @PreAuthorize("#userId == authentication.principal.userId or hasAuthority('ADMIN')")
    public ResponseEntity<Void> deleteProfile(@PathVariable Long userId) {
        userProfileService.deleteUserProfile(userId);
        return ResponseEntity.noContent().build();
    }

    // Admin only: Get all user profiles
    @GetMapping
   @PreAuthorize("hasAuthority('ADMIN')")
    public ResponseEntity<List<UserProfileDTO>> getAllProfiles() {
        List<UserProfileDTO> profiles = userProfileService.getAllUserProfiles();
        return ResponseEntity.ok(profiles);
    }

    // Upload profile photo for a user (user or admin can upload)
    @PostMapping("/{userId}/photo")
    @PreAuthorize("#userId == authentication.principal.userId or hasAuthority('ADMIN')")
    public ResponseEntity<String> uploadPhoto(@PathVariable Long userId,
                                              @RequestParam("file") MultipartFile file) {
        try {
            String filename = userProfileService.storePhoto(userId, file);
            return ResponseEntity.ok("Photo uploaded successfully: " + filename);
        } catch (IOException e) {
            return ResponseEntity.internalServerError()
                    .body("Error uploading photo: " + e.getMessage());
        }
    }

    // Admin only: Get profiles filtered by role
    @GetMapping("/role/{role}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public ResponseEntity<List<UserProfileDTO>> getProfilesByRole(@PathVariable String role) {
        List<UserProfileDTO> profiles = userProfileService.getProfilesByRole(role.toUpperCase());
        return ResponseEntity.ok(profiles);
    }
    
 // Admin only: Get profiles filtered by role
//    AuthServiceClient authServiceClient ;
//    @GetMapping("/role/{role}")
//    //@PreAuthorize("hasAuthority('ADMIN')")
//    public ResponseEntity<List<AuthUserDTO>> getProfilesByRole(@PathVariable String role) {
//        List<AuthUserDTO> profiles = authServiceClient.getUsersByRole(role.toUpperCase());
//        return ResponseEntity.ok(profiles);
//    }
    
    @GetMapping("/name")
    public String name() {
    	return "Ashu";
    }
}
