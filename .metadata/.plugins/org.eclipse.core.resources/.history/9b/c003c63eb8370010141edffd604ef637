package com.user_service.service.impl;

import com.user_service.dto.UserProfileDTO;
import com.user_service.entity.UserProfile;
import com.user_service.repository.UserProfileRepository;
import com.user_service.service.UserProfileService;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.*;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional
public class UserProfileServiceImpl implements UserProfileService {

    private final UserProfileRepository userProfileRepository;

    private final Path rootLocation = Paths.get("uploads/profile-photos");

    @Override
    public UserProfileDTO createUserProfile(UserProfileDTO dto) {
        if (dto == null) {
            throw new IllegalArgumentException("UserProfileDTO cannot be null");
        }
        UserProfile userProfile = toEntity(dto);
        userProfile = userProfileRepository.save(userProfile);
        return toDTO(userProfile);
    }

    @Override
    public UserProfileDTO updateUserProfile(UserProfileDTO dto) {
        if (dto == null || dto.getUserId() == null) {
            throw new IllegalArgumentException("UserProfileDTO or userId cannot be null");
        }

        UserProfile existing = userProfileRepository.findById(dto.getUserId())
                .orElseThrow(() -> new RuntimeException("User profile not found with id " + dto.getUserId()));

        // Update fields selectively to avoid overwriting critical data
        existing.setFirstName(dto.getFirstName());
        existing.setLastName(dto.getLastName());
        existing.setPhoneNumber(dto.getPhoneNumber());
        existing.setBio(dto.getBio());
        existing.setProfileImageUrl(dto.getProfileImageUrl());
        existing.setRole(dto.getRole());
        existing.setEnabled(dto.getEnabled());

        userProfileRepository.save(existing);
        return toDTO(existing);
    }

    @Override
    public Optional<UserProfileDTO> getUserProfile(Long userId) {
        if (userId == null) {
            return Optional.empty();
        }
        return userProfileRepository.findById(userId).map(this::toDTO);
    }

    @Override
    public void deleteUserProfile(Long userId) {
        if (userId == null) {
            throw new IllegalArgumentException("UserId cannot be null");
        }
        userProfileRepository.deleteById(userId);
    }

    @Override
    public List<UserProfileDTO> getAllUserProfiles() {
        return userProfileRepository.findAll()
                .stream()
                .map(this::toDTO)
                .collect(Collectors.toList());
    }

    @Override
    public List<UserProfileDTO> getProfilesByRole(String role) {
        if (role == null || role.isBlank()) {
            throw new IllegalArgumentException("Role must be provided");
        }
        return userProfileRepository.findByRole(role.toUpperCase())
                .stream()
                .map(this::toDTO)
                .collect(Collectors.toList());
    }

    @Override
    public String storePhoto(Long userId, MultipartFile file) throws IOException {
        if (userId == null) {
            throw new IllegalArgumentException("UserId cannot be null");
        }
        if (file == null || file.isEmpty()) {
            throw new RuntimeException("Failed to store empty file.");
        }

        // Ensure directory exists
        Files.createDirectories(rootLocation);

        String filename = userId + "_" + Path.of(file.getOriginalFilename()).getFileName();
        Path destinationFile = rootLocation.resolve(filename).normalize().toAbsolutePath();

        // Copy file (replace existing if exists)
        try (var inputStream = file.getInputStream()) {
            Files.copy(inputStream, destinationFile, StandardCopyOption.REPLACE_EXISTING);
        }

        UserProfile profile = userProfileRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("User profile not found"));

        profile.setProfileImageUrl("/uploads/profile-photos/" + filename);
        userProfileRepository.save(profile);

        return filename;
    }

    // Helper to convert Entity -> DTO
    private UserProfileDTO toDTO(UserProfile entity) {
        if (entity == null) return null;
        return UserProfileDTO.builder()
                .userId(entity.getAuthUserId())
                .email(entity.getEmail())
                .username(entity.getUsername())
                .role(entity.getRole())
                .enabled(entity.getEnabled())
                .firstName(entity.getFirstName())
                .lastName(entity.getLastName())
                .phoneNumber(entity.getPhoneNumber())
                .bio(entity.getBio())
                .profileImageUrl(entity.getProfileImageUrl())
                .build();
    }

    // Helper to convert DTO -> Entity
    private UserProfile toEntity(UserProfileDTO dto) {
        if (dto == null) return null;
        return UserProfile.builder()
                .authUserId(dto.getUserId())
                .email(dto.getEmail())
                .username(dto.getUsername())
                .role(dto.getRole())
                .enabled(dto.getEnabled())
                .firstName(dto.getFirstName())
                .lastName(dto.getLastName())
                .phoneNumber(dto.getPhoneNumber())
                .bio(dto.getBio())
                .profileImageUrl(dto.getProfileImageUrl())
                .build();
    }
}
