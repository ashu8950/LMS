//package com.gateway_service.config;
//
//import io.jsonwebtoken.Claims;
//import org.springframework.http.HttpHeaders;
//import org.springframework.security.authentication.ReactiveAuthenticationManager;
//import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
//import org.springframework.security.core.Authentication;
//import org.springframework.security.core.authority.SimpleGrantedAuthority;
//import org.springframework.security.web.server.authentication.AuthenticationWebFilter;
//import org.springframework.security.web.server.context.NoOpServerSecurityContextRepository;
//import org.springframework.web.server.ServerWebExchange;
//import org.springframework.stereotype.Component;
//import reactor.core.publisher.Mono;
//
//import java.util.List;
//import java.util.stream.Collectors;
//
//@Component
//public class JwtAuthenticationFilter extends AuthenticationWebFilter {
//
//    private final JwtUtil jwtUtil;
//
//    public JwtAuthenticationFilter(JwtUtil jwtUtil) {
//        super(new JwtReactiveAuthenticationManager());
//        this.jwtUtil = jwtUtil;
//
//        // Set the authentication converter using method reference or lambda
//        setServerAuthenticationConverter(this::tryConvert);
//
//        // Disable saving SecurityContext because we are stateless
//        setSecurityContextRepository(NoOpServerSecurityContextRepository.getInstance());
//    }
//
//    // Method to convert ServerWebExchange to Mono<Authentication>
//    private Mono<Authentication> tryConvert(ServerWebExchange exchange) {
//        String path = exchange.getRequest().getURI().getPath();
//
//        // Allow unauthenticated access to /auth/** endpoints
//        if (path.startsWith("/auth/")) {
//            return Mono.empty();
//        }
//
//        String authHeader = exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
//        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
//            return Mono.empty();
//        }
//
//        String token = authHeader.substring(7);
//
//        if (!jwtUtil.validateToken(token)) {
//            return Mono.empty();
//        }
//
//        Claims claims = jwtUtil.getAllClaimsFromToken(token);
//        String username = claims.getSubject();
//        @SuppressWarnings("unchecked")
//        List<String> roles = claims.get("roles", List.class);
//
//        List<SimpleGrantedAuthority> authorities = roles.stream()
//                .map(SimpleGrantedAuthority::new)
//                .collect(Collectors.toList());
//
//        Authentication auth = new UsernamePasswordAuthenticationToken(username, token, authorities);
//        return Mono.just(auth);
//    }
//
//    // Simple ReactiveAuthenticationManager implementation
//    private static class JwtReactiveAuthenticationManager implements ReactiveAuthenticationManager {
//        @Override
//        public Mono<Authentication> authenticate(Authentication authentication) {
//            authentication.setAuthenticated(true);
//            return Mono.just(authentication);
//        }
//    }
//}
